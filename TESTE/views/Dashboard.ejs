<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EsquizoCord</title>
    <link rel="icon" type="image/png" href="/images/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-tertiary: #202225;
            --header-primary: #fff;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --brand-experiment: #660080;
            --brand-hover: #572364;
            --purple-accent: #cc00ff;
            --green-accent: #43B581;
            --red-danger: #f04747;
            --red-danger-hover: #d84040;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow: hidden; color: var(--text-normal); background-color: var(--background-tertiary); }
        .dashboard-layout { display: flex; height: 100vh; }
        .server-list { width: 72px; background-color: var(--background-tertiary); padding: 12px 0; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; border-radius: 50%; background-color: var(--background-primary); margin-bottom: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: border-radius 0.3s, background-color 0.3s; }
        .server-icon:hover, .server-icon.active { border-radius: 16px; background-color: var(--brand-experiment); }
        .server-icon img { width: 100%; height: 100%; border-radius: inherit; object-fit: cover; }
        .divider { height: 2px; width: 32px; background-color: var(--background-secondary); margin: 8px 0; }
        .profile-icon-container { margin-top: auto; }
        .profile-icon { border: 2px solid var(--text-muted); }
        .profile-icon:hover { border-color: var(--purple-accent); }
        
        /* --- CORREÇÃO DE LAYOUT --- */
        .channel-list { 
            width: 260px; /* Aumentado de 240px para 260px para dar mais espaço */
            background-color: var(--background-secondary); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
        }
        .channel-header { padding: 12px; box-shadow: 0 1px 0 rgba(0,0,0,0.2); font-weight: bold; color: var(--header-primary); display: flex; justify-content: space-between; align-items: center; }
        #group-settings-icon { color: var(--text-muted); cursor: pointer; display: none; }
        #group-settings-icon:hover { color: var(--header-primary); }
        .channel-list-content { padding: 12px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;}
        .channel-list-header { color: var(--text-muted); font-size: 12px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .friend-item { display: flex; align-items: center; padding: 8px; border-radius: 4px; cursor: pointer; gap: 8px; }
        .friend-item:hover { background-color: rgba(255,255,255,0.04); }
        .friend-item img { width: 32px; height: 32px; border-radius: 50%; }
        .admin-icon { color: #f1c40f; font-size: 10px; margin-left: auto; }
        .friend-request-item { background-color: var(--background-tertiary); padding: 8px; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .request-actions { display: flex; gap: 10px; }
        .request-actions button { background: none; border: none; cursor: pointer; font-size: 20px; }
        .accept-btn { color: var(--green-accent); }
        .reject-btn, .cancel-request-btn { color: var(--red-danger); }
        
        .user-panel { background-color: #292b2f; padding: 12px; display: flex; align-items: center; }
        .user-panel img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
        .user-panel .username { font-weight: bold; }
        .chat-area { flex-grow: 1; background-color: var(--background-primary); display: flex; flex-direction: column; }
        .chat-header { padding: 12px 16px; box-shadow: 0 1px 0 rgba(0,0,0,0.2); font-weight: bold; color: var(--header-primary); display: flex; align-items: center; gap: 8px; }
        .chat-header h3 { margin: 0; font-size: 16px; display: inline; }
        .chat-header .group-id { color: var(--text-muted); font-size: 12px; }
        .chat-messages { flex-grow: 1; padding: 16px; overflow-y: auto; }
        .chat-input-bar { padding: 0 16px 24px 16px; }
        .chat-input-bar input { width: 100%; padding: 12px; border-radius: 8px; border: none; background-color: #40444b; color: var(--text-normal); }
        .chat-input-bar input::placeholder { color: var(--text-muted); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--background-secondary); padding: 24px; border-radius: 8px; width: 90%; max-width: 440px; display: flex; flex-direction: column; }
        .modal-content.large { max-width: 520px; height: 70vh; }
        .modal-content h3 { text-align: center; margin-top: 0; }
        .modal-content label { font-weight: bold; color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px; }
        .modal-content input[type="text"], .modal-content input[type="file"], .modal-content input[type="search"] { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid var(--background-tertiary); background-color: var(--background-tertiary); color: var(--text-normal); margin-bottom: 20px; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .checkbox-container label { margin: 0; font-size: 14px; color: var(--text-normal); }
        .modal-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .modal-actions button { padding: 10px 24px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .cancel-btn { background: none; color: var(--header-primary); }
        .submit-btn, .join-btn, .add-friend-btn { background-color: var(--brand-experiment); color: white; }
        .join-btn:hover, .add-friend-btn:hover { background-color: var(--brand-hover); }
        .delete-btn { background-color: var(--red-danger); color: white; }
        .delete-btn:hover { background-color: var(--red-danger-hover); }
        
        #search-results, .friend-requests-container { flex-grow: 1; overflow-y: auto; margin-top: 10px; }
        .search-result-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 4px; margin-bottom: 8px; background-color: var(--background-primary); }
        .search-result-info { display: flex; align-items: center; gap: 10px; }
        .search-result-info img { width: 40px; height: 40px; border-radius: 50%; }
        .search-result-name .group-id-search { color: var(--text-muted); font-size: 12px; }
        .friends-nav { 
            display: flex; 
            padding: 12px; 
            gap: 8px; 
            border-bottom: 1px solid var(--background-tertiary); 
        }
        .friends-nav-btn { 
            flex: 1;
            background: #4f545c; 
            border: none; 
            color: var(--text-normal); 
            padding: 8px 4px; 
            cursor: pointer; 
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            line-height: 1.3;
            min-height: 38px;
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap; /* Impede que o texto quebre */
        }
        .friends-nav-btn.active { background-color: var(--brand-experiment); }
        .add-friend-container p { font-size: 12px; color: var(--text-muted); margin-top: 0; margin-bottom: 10px; }
        .add-friend-input { display: flex; width: 100%; }
        .add-friend-input input { 
            flex-grow: 1;
            width: 1%;
            min-width: 0;
            border: 1px solid var(--background-tertiary);
            background-color: var(--background-tertiary);
            color: var(--text-normal);
            padding: 8px;
            border-radius: 3px 0 0 3px;
            border-right: none;
        }
        .add-friend-input button { 
            flex-shrink: 0;
            white-space: nowrap;
            border-radius: 0 3px 3px 0; 
            background-color: var(--brand-experiment);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body 
    data-user='<%- JSON.stringify(user || null) %>'
    data-groups='<%- JSON.stringify(groups || []) %>'
    data-friends='<%- JSON.stringify(friends || []) %>'
    data-pending-requests='<%- JSON.stringify(pendingRequests || []) %>'
    data-sent-requests='<%- JSON.stringify(sentRequests || []) %>'
>
    <div class="dashboard-layout">
        <nav class="server-list">
            <div class="server-icon active" id="home-button" title="Início">
                 <img src="/images/logo.png" alt="Início">
            </div>
            <div class="divider"></div>
            <% if (groups && groups.length > 0) { %>
                <% groups.forEach(group => { %>
                    <div class="server-icon" title="<%= group.Nome %>" data-group-id="<%= group.id_grupo %>">
                        <img src="<%= group.Foto || '/images/default-group-icon.png' %>" alt="<%= group.Nome %>">
                    </div>
                <% }); %>
            <% } %>
            <div class="server-icon" id="add-server-button" title="Adicionar um servidor">
                <i class="fas fa-plus" style="color: var(--green-accent);"></i>
            </div>
            <div class="server-icon" id="explore-button" title="Explorar Servidores">
                <i class="fas fa-compass" style="color: var(--green-accent);"></i>
            </div>
            <div class="profile-icon-container">
                 <a href="/configuracao">
                    <% if (user && user.FotoPerfil) { %>
                        <img src="<%= user.FotoPerfil %>" alt="Perfil" class="server-icon profile-icon">
                    <% } else { %>
                        <img src="/images/logo.png" alt="Perfil" class="server-icon profile-icon">
                    <% } %>
                 </a>
            </div>
        </nav>
        <aside class="channel-list">
            <div class="channel-header">
                <span id="group-name-header">Amigos</span>
                <i class="fas fa-cog" id="group-settings-icon" title="Configurações do Grupo"></i>
            </div>
            <div id="friends-nav-container" class="friends-nav">
                <button class="friends-nav-btn active" data-tab="friends-list">Amigos</button>
                <button class="friends-nav-btn" data-tab="pending-requests">Pendentes</button>
                <button class="friends-nav-btn" data-tab="add-friend">Adicionar Amigo</button>
            </div>
            <div class="channel-list-content" id="channel-list-content">
                <!-- Conteúdo dinâmico aqui -->
            </div>
            <div class="user-panel">
                 <% if (user) { %>
                     <img src="<%= user.FotoPerfil || '/images/logo.png' %>" alt="Perfil">
                     <span class="username"><%= user.Nome %></span>
                 <% } %>
            </div>
        </aside>
        <main class="chat-area">
            <div class="chat-header" id="chat-header"><h3>Mensagens Diretas</h3></div>
            <div class="chat-messages" id="chat-messages-container"><p>Selecione um amigo para começar a conversar.</p></div>
            <div class="chat-input-bar"><input type="text" placeholder="Conversar..."></div>
        </main>
    </div>

    <!-- Modais -->
    <div class="modal-overlay" id="create-group-modal">
        <div class="modal-content">
            <h3>Crie o seu servidor</h3>
            <form id="create-group-form">
                <label for="group-name">NOME DO SERVIDOR</label>
                <input type="text" id="group-name" name="nome" required>
                <label for="group-photo">FOTO DO SERVIDOR (Opcional)</label>
                <input type="file" id="group-photo" name="foto" accept="image/*">
                <div class="checkbox-container">
                    <input type="checkbox" id="group-private-create" name="isPrivate">
                    <label for="group-private-create">Grupo Privado</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn">Cancelar</button>
                    <button type="submit" class="submit-btn">Criar</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="edit-group-modal">
        <div class="modal-content">
            <h3>Configurações do Grupo</h3>
            <form id="edit-group-form">
                <input type="hidden" id="edit-group-id" name="groupId">
                <label for="edit-group-name">NOME DO SERVIDOR</label>
                <input type="text" id="edit-group-name" name="nome" required>
                <label for="edit-group-photo">FOTO DO SERVIDOR</label>
                <input type="file" id="edit-group-photo" name="foto" accept="image/*">
                <div class="checkbox-container">
                    <input type="checkbox" id="edit-group-private" name="isPrivate">
                    <label for="edit-group-private">Grupo Privado</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="delete-btn" id="delete-group-btn">Excluir Grupo</button>
                    <div>
                        <button type="button" class="cancel-btn">Cancelar</button>
                        <button type="submit" class="submit-btn">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="explore-group-modal">
        <div class="modal-content large">
            <h3>Explorar Servidores Públicos</h3>
            <form id="search-group-form">
                 <input type="search" id="search-group-input" placeholder="Pesquisar grupos públicos...">
            </form>
            <div id="search-group-results"></div>
             <div class="modal-actions">
                <button type="button" class="cancel-btn">Fechar</button>
            </div>
        </div>
    </div>
    
    <script src="/js/dashboard.js"></script>
</body>
</html>
